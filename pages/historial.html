<!DOCTYPE html>
<html>

<head>
    <title>Proyecto Dise√±o MJSF</title>
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.3.1.min.js"></script>
    <!-- Https Source for datepicker -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <!-- <link rel="stylesheet" href="/resources/demos/style.css"> -->

    <!-- Local Sources -->
    <script src="../http.js"></script>
    <link rel="stylesheet" href="../css/webstyle.css">

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <!-- Sources for timepicker (Local Sources) -->
    <script src="../jquery-timepicker/jquery.timepicker.min.js"></script>
    <link rel="stylesheet" href="../jquery-timepicker/jquery.timepicker.css">

    <!-- Start ID for datepicker -->
    <script>
        $(function () {
            $("#date1").datepicker({
                dateFormat: "dd/mm/yy"
            });
            $("#date2").datepicker({
                dateFormat: "dd/mm/yy"
            });
        });
    </script>
    <style>
        /* Difinicion de Layout para google Maps  */

        #map {
            height: 500px;
            width: 100%;
        }
    </style>

    <!-- Fuentes de bootstrap -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Bootstrap core CSS -->
    <link href="../bootstrap/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color:#811411">
        <div class="container">
            <a class="navbar-brand" style="font-size:25px ; font-family:sans-serif" href="#">AquiToy
                <img style="width:35px" src="../img/logo.svg">
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive"
                aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="navTimeRealPage()">Tiempo Real</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="#">Historicos
                            <span class="sr-only">(current)</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Services</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Contact</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- <section> -->
    <div id="map"></div>
    <!-- </section> -->
    <!-- Historical Data Input -->
    <p class="order">
        <input type="text" id="date1" />
        <input type="text" id="time1" /> to
        <input type="text" id="date2" />
        <input type="text" id="time2" />
    </p>
    <script>
        //Start Class for timepicker
        $('#time1').timepicker({
            'showDuration': true,
            'timeFormat': 'H:i:s'
        });
        $('#time2').timepicker({
            'showDuration': true,
            'timeFormat': 'H:i:s'
        });
    </script>

    <button onclick="generateSTcode()">Enviar</button>

    <script>
        var timems_1 = 240;
        var timems_2 = 254;
        var client = httpclient(); // Request for google roads api
        var flightPlanCoordinates = []; // Definicion para vector de puntos en polilinea
        var bandera = 0; //Bandera para centrar mapa en mitad de recorrido historico
        var theurl = 'https://roads.googleapis.com/v1/snapToRoads?path='
        var data = [[], []] //Array Multi for save historical data (lat, lng)


        function navTimeRealPage() {
            window.location.href = '../index.html'
        }

        function generateSTcode() {
            var timems_1 = 240;
            var timems_2 = 250;
            //Data of calendar and hours
            var DATE_1 = new Date($("#date1").datepicker("getDate"))
            var date_1 = [DATE_1.getDate(), DATE_1.getMonth(), DATE_1.getFullYear()];

            var TIME_1 = new Date($("#time1").timepicker("getTime"))
            var time_1 = [TIME_1.getHours(), TIME_1.getMinutes()]

            var DATE_2 = new Date($("#date2").datepicker("getDate"))
            var date_2 = [DATE_2.getDate(), DATE_2.getMonth(), DATE_2.getFullYear()];

            var TIME_2 = new Date($("#time2").timepicker("getTime"))
            var time_2 = [TIME_2.getHours(), TIME_2.getMinutes()]

            var date_1_UTC = new Date(date_1[2], date_1[1], date_1[0], time_1[0], time_1[1])
            date_1_UTC = date_1_UTC.getTime() //Time in miliseconds

            var date_2_UTC = new Date(date_2[2], date_2[1], date_2[0], time_2[0], time_2[1])
            date_2_UTC = date_2_UTC.getTime() //Time in miliseconds

            // Traduccion de archivo php a script
            var infodb = function () {
                var temporal = null;
                $.ajax({
                    'async': false,
                    'type': "POST",
                    'global': false,
                    'dataType': 'html',
                    'data': { posttimems1: timems_1, posttimems2: timems_2 },
                    'url': "../historicalGet.php",
                    'success': function (data) {
                        temporal = data;
                    }
                });
                return temporal;
            }();
            if (infodb == null) {
                infodb = "";
            }

            infodb = infodb.split(" ")
            console.log(infodb)
            theurl = 'https://roads.googleapis.com/v1/snapToRoads?path='
            for (let i = 0; i < infodb.length / 2; i++) {
                data[0][i] = infodb[i]
                data[1][i] = infodb[i + infodb.length / 2]
                //With Google Roads API
                theurl = theurl.concat(data[0][i], ",", data[1][i])
                if (i != infodb.length / 2 - 1) {
                    theurl = theurl.concat("|")
                }
                // flightPlanCoordinates.push({ lat: Number(data[0][i]), lng: Number(data[1][i]) })
            }
            console.log(data)
            bandera = 1;
            initMap(bandera, theurl, data)
        }

        function initMap() {
            var startMarker = new google.maps.Marker({});
            var endMarker = new google.maps.Marker({});
            var center = { lat: 10.986532, lng: -74.809226 }
            var startMarkerPosition = { lat: 0, lng: 0 }
            var endMarkerPosition = { lat: 0, lng: 0 }

            if (bandera == 1) { // Centrar mapa en recorrido historico
                center = {
                    lat: Number(data[0][Math.round(data.length / 2)]),
                    lng: Number(data[1][Math.round(data.length / 2)])
                }
                startMarkerPosition = {
                    lat: Number(data[0][0]),
                    lng: Number(data[1][0])
                }
                endMarkerPosition = {
                    lat: Number(data[0][data[0].length - 1]),
                    lng: Number(data[1][data[1].length - 1])
                }
            }
            // Inicializacion de Variables Google Maps
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 13,
                center: center
            });

            var startMarker = new google.maps.Marker({
                position: startMarkerPosition,
                map: map,
                animation: google.maps.Animation.DROP,
                label: 'A'
            })

            var endMarker = new google.maps.Marker({
                position: endMarkerPosition,
                map: map,
                animation: google.maps.Animation.DROP,
                label: 'B'
            })

            // With Google Roads API
            if (bandera == 1) {
                var TheURL = theurl.concat("&interpolate=true&key=AIzaSyBNPUIW6WUc1Cg5sQfivG0loxKZj1Bn9zE")
                console.log(TheURL)
                client.get(TheURL, function (response) {
                    var response1 = JSON.parse(response);
                    for (let i = 0; i < response1.snappedPoints.length; i++) {
                        flightPlanCoordinates.push({
                            lat: response1.snappedPoints[i].location.latitude,
                            lng: response1.snappedPoints[i].location.longitude
                        })
                    }
                    drawPolylines(flightPlanCoordinates)
                })
                bandera = 0;
            }
            function drawPolylines() {
                var flightPath = new google.maps.Polyline({ // Parametros de entrada para Polilinea
                    path: flightPlanCoordinates,
                    geodesic: true,
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 4
                });
                flightPath.setMap(map);
            }
        }
    </script>
    <!-- <script src="../bootstrap/vendor/jquery/jquery.min.js"></script> -->
    <script src="../bootstrap/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCBOaRqI8IcgcQlXj5Evtv-0KgcHccWbeM&callback=initMap"> </script>
    <h1 style="text-align:center" id="test"></h1>
    <h2></h2>
</body>

</html>